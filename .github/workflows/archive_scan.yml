name: Archive Scan Results

"on":
  workflow_run:
    workflows: ["Trust Scan Bot"]
    types:
      - completed

permissions:
  contents: write

jobs:
  archive-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Timestamp scan_results.json
        run: |
          if [ -f output/scan_results.json ]; then
            ts=$(date -u +'%Y-%m-%d_%H-%M-%S')
            mkdir -p archive
            cp output/scan_results.json archive/scan_results_${ts}.json
            echo "✅ Archived scan_results.json as scan_results_${ts}.json"
          else
            echo "⚠️ output/scan_results.json not found, skipping archive"
            exit 0
          fi

      - name: Configure Git
        run: |
          git config user.name "TrustBot"
          git config user.email "trustbot@travisryle.org"

      - name: Commit archive file
        run: |
          git add archive/
          if git diff --cached --quiet; then
            echo "✅ No changes to commit."
          else
            timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
            git commit -m "Archive scan results at ${timestamp}"
            git pull --rebase origin main
            git push
            echo "✅ Archive committed and pushed successfully"
          fi
