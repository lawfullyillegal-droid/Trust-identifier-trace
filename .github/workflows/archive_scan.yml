name: Archive Scan Results

on:
  workflow_run:
    workflows: ["Trust Scan Bot"]
    types:
      - completed

jobs:
  archive-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Timestamp scan_results.json
        run: |
          if [ -f output/scan_results.json ]; then
            ts=$(date -u +'%Y-%m-%d_%H-%M-%S')
            mkdir -p archive
            cp output/scan_results.json archive/scan_results_${ts}.json
            echo "Archived scan_results.json to archive/scan_results_${ts}.json"
          else
            echo "Warning: output/scan_results.json not found, skipping archive"
            mkdir -p archive
            touch archive/.gitkeep
          fi

      - name: Configure Git
        run: |
          git config user.name "TrustBot"
          git config user.email "trustbot@travisryle.org"

      - name: Commit archive file
        run: |
          git add archive/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Archive scan results at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi
