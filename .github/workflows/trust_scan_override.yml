name: Trust Scan Override

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pyyaml
          fi
      
      - name: Create necessary directories
        run: |
          mkdir -p output archive overlays

      - name: Run Trust Scan Bot
        run: |
          echo "Running trust_scan_bot.py..."
          if [ -f trust_scan_bot.py ]; then
            python trust_scan_bot.py
            echo "‚úÖ Trust scan completed successfully"
          else
            echo "‚ùå ERROR: trust_scan_bot.py not found"
            exit 1
          fi

      - name: Show scan results
        run: |
          echo "üìä Scan Results:"
          echo "===================="
          
          # Show log file
          if [ -f TrustScanLog.txt ]; then
            echo "üìÑ TrustScanLog.txt:"
            cat TrustScanLog.txt
          else
            echo "‚ö†Ô∏è  TrustScanLog.txt not found"
          fi
          
          # Show output files
          if [ -f output/scan_results.json ]; then
            echo ""
            echo "üìä Scan Results (last 20 lines):"
            tail -n 20 output/scan_results.json
          else
            echo "‚ö†Ô∏è  output/scan_results.json not found"
          fi
          
          # Show scan log
          if [ -f output/scan_log.txt ]; then
            echo ""
            echo "üìù Scan Log (last 10 lines):"
            tail -n 10 output/scan_log.txt
          else
            echo "‚ö†Ô∏è  output/scan_log.txt not found"
          fi

      - name: Commit scan results
        run: |
          git config --global user.name "TrustBot"
          git config --global user.email "trustbot@github.com"
          
          # Add all scan output files
          git add TrustScanLog.txt output/scan_results.json output/scan_log.txt overlays/*.yml || echo "Nothing to add"
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
          else
            git commit -m "Override scan: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase origin main || echo "‚ö†Ô∏è  Rebase failed, attempting push anyway"
            git push || echo "‚ö†Ô∏è  Push failed - this may need manual resolution"
            echo "‚úÖ Results committed and pushed"
          fi
