<!DOCTYPE html>
<html>
<head>
  <title>Trust Scan Dashboard</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #444; padding: 8px; text-align: left; }
    th { background: #222; }
    .verified { color: #0f0; }
    .flagged { color: #ff0; }
    .unmatched { color: #f00; }
  </style>
</head>
<body>
  <h1>Trust Scan Dashboard</h1>

  <input type="text" id="searchBar" placeholder="üîç Search identifiers, sources, overlays..." style="width:100%; padding:10px; font-size:16px; margin-bottom:20px;">
  <div id="summary"></div>

  <table id="results">
    <tr><th>Identifier</th><th>Status</th><th>Source</th><th>Timestamp</th><th>Overlay</th></tr>
  </table>

  <h2 style="margin-top:40px;">üß† Visual Trace Map</h2>
  <div id="traceMap" style="width:100%; height:500px; background:#222; border:1px solid #444;"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    fetch('output/scan_results.json')
      .then(res => res.json())
      .then(data => {
        const table = document.getElementById('results');
        const summary = document.getElementById('summary');
        const searchBar = document.getElementById('searchBar');

        let verified = 0, flagged = 0, unmatched = 0;

        function renderTable(filteredData) {
          table.innerHTML = '<tr><th>Identifier</th><th>Status</th><th>Source</th><th>Timestamp</th><th>Overlay</th></tr>';
          filteredData.forEach(item => {
            if (item.status === "verified") verified++;
            else if (item.status === "flagged") flagged++;
            else unmatched++;

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.identifier}</td>
              <td class="${item.status}">${item.status}</td>
              <td>${item.source}</td>
              <td>${item.timestamp}</td>
              <td><a href="${item.overlay}" style="color:#0ff">View Overlay</a></td>
            `;
            table.appendChild(row);
          });

          summary.innerHTML = `
            <p>‚úÖ Verified: ${verified}</p>
            <p>‚ö†Ô∏è Flagged: ${flagged}</p>
            <p>‚ùå Unmatched: ${unmatched}</p>
          `;
        }

        renderTable(data);

        searchBar.addEventListener('input', () => {
          const query = searchBar.value.toLowerCase();
          const filtered = data.filter(item =>
            item.identifier.toLowerCase().includes(query) ||
            item.source.toLowerCase().includes(query) ||
            item.overlay.toLowerCase().includes(query)
          );
          verified = flagged = unmatched = 0;
          renderTable(filtered);
        });
      })
      .catch(err => {
        document.getElementById('summary').innerHTML = "<p style='color:red'>Failed to load scan results.</p>";
      });

    // Visual Trace Map with fallback
    if (typeof d3 !== 'undefined') {
      // D3.js visualization code
      const nodes = [
        { id: "CORP-NUM-C2362627", group: "Identifier" },
        { id: "OpenCorporates", group: "Registry" },
        { id: "LN-NAME-RYLE-TRAVIS-STEVEN", group: "Identifier" },
        { id: "LexisNexis", group: "Registry" },
        { id: "PROP-SS-GUARANTEE-104-0190-003558", group: "Identifier" },
        { id: "IRS Form 1099-A", group: "Registry" },
        { id: "IRS-TRACK-108541264370", group: "Identifier" },
        { id: "IRS Non-Filing", group: "Registry" },
        { id: "EIN-92-6319308", group: "Identifier" },
        { id: "EIN Registry", group: "Registry" }
      ];

      const links = [
        { source: "CORP-NUM-C2362627", target: "OpenCorporates" },
        { source: "LN-NAME-RYLE-TRAVIS-STEVEN", target: "LexisNexis" },
        { source: "PROP-SS-GUARANTEE-104-0190-003558", target: "IRS Form 1099-A" },
        { source: "IRS-TRACK-108541264370", target: "IRS Non-Filing" },
        { source: "EIN-92-6319308", target: "EIN Registry" }
      ];

      const svg = d3.select("#traceMap").append("svg")
        .attr("width", "100%")
        .attr("height", 500);

      const width = document.getElementById("traceMap").clientWidth;
      const height = 500;

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.append("g")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke", "#888")
        .attr("stroke-width", 2);

      const node = svg.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", 10)
        .attr("fill", d => d.group === "Registry" ? "#0ff" : "#0f0")
        .call(drag(simulation));

      const label = svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .text(d => d.id)
        .attr("fill", "#eee")
        .attr("font-size", "12px");

      function drag(simulation) {
        function dragstarted(event) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
        }
        function dragged(event) {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
        }
        function dragended(event) {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
        }
        return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
      }

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => d.x + 12)
          .attr("y", d => d.y + 4);
      });
    } else {
      // Fallback when D3.js is not available
      document.getElementById("traceMap").innerHTML = `
        <div style="padding: 50px; text-align: center; color: #888;">
          <h3>üìä Visual Trace Map</h3>
          <p>Interactive visualization requires D3.js library</p>
          <p style="margin-top: 20px;">Identifier connections:</p>
          <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
            <li>CORP-NUM-C2362627 ‚Üí OpenCorporates</li>
            <li>LN-NAME-RYLE-TRAVIS-STEVEN ‚Üí LexisNexis</li>
            <li>PROP-SS-GUARANTEE-104-0190-003558 ‚Üí IRS Form 1099-A</li>
            <li>IRS-TRACK-108541264370 ‚Üí IRS Non-Filing</li>
            <li>EIN-92-6319308 ‚Üí EIN Registry</li>
          </ul>
        </div>
      `;
    }
  </script>
</body>
</html>
