import requests
from reddit_trace import query_reddit_threads

def scan_identifier(identifier):
    value = identifier["identifier"]
    hits = {}

    # 1️⃣ Reddit symbolic trace
    reddit_hits = query_reddit_threads(value)
    if reddit_hits:
        hits["reddit_hits"] = reddit_hits

    # 2️⃣ SEC EDGAR search
    try:
        sec_url = f"https://efts.sec.gov/LATEST/search-index?q={value}"
        sec_resp = requests.get(sec_url, headers={"User-Agent": "TrustScanBot/1.0"})
        if sec_resp.status_code == 200 and value.lower() in sec_resp.text.lower():
            hits["sec_match"] = True
    except Exception as e:
        hits["sec_error"] = str(e)

    # 3️⃣ U.S. Treasury / Fiscal Service search
    try:
        treasury_url = f"https://www.treasurydirect.gov/TA_WS/securities?search={value}"
        treasury_resp = requests.get(treasury_url, headers={"User-Agent": "TrustScanBot/1.0"})
        if treasury_resp.status_code == 200 and value.lower() in treasury_resp.text.lower():
            hits["treasury_match"] = True
    except Exception as e:
        hits["treasury_error"] = str(e)

    # 4️⃣ Los Angeles County Registrar (public search portal)
    try:
        la_url = f"https://apps.lavote.net/BDM/Index.cfm?search={value}"
        la_resp = requests.get(la_url, headers={"User-Agent": "TrustScanBot/1.0"})
        if la_resp.status_code == 200 and value.lower() in la_resp.text.lower():
            hits["la_county_match"] = True
    except Exception as e:
        hits["la_county_error"] = str(e)

    # Return status
    if hits:
        identifier.update(hits)
        return "matched"
    return "unverified"
